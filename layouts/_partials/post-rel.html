{{- $show := default true (default .Site.Params.ShowRelPost .Params.ShowRelPost) -}}
{{- $page := . -}}
{{- if $show -}}
  {{- if .Site.Params.HugoRelPost -}}
    {{ with site.RegularPages.Related $page | first .Site.Params.HugoRelPostLimit }}
      <div class="asideblock rel-post">
        <details open class="menu-fold">
          <summary>Related</summary>
          <menu class="indentline">
            {{- range . -}}
              <li>
                <a class="sidelink" href="{{- .RelPermalink -}}"
                  >{{- .Title -}}</a
                >
              </li>
            {{- end -}}
          </menu>
        </details>
      </div>
    {{- end -}}
  {{- else -}}
    <div class="asideblock rel-post">
      <details open class="menu-fold">
        <summary>Related</summary>
        <menu class="indentline">
          {{- $taxonomyTitles := .Site.Params.taxonomyTitles -}}
          {{- $flag := 0 -}}
          {{- range $taxonomyName, $taxonomy := .Site.Taxonomies -}}
            {{- $terms := ($page.GetTerms $taxonomyName) -}}
            {{- with $terms -}}
              {{- $flag = 0 -}}
              {{- range . -}}
                {{- $flag = add $flag (len .RegularPages) -}}
                {{- $flag = sub $flag 1 -}}
              {{- end -}}
              {{- if $flag -}}
                <li>
                  <details open class="menu-fold">
                    <summary>{{- $taxonomyName -}}</summary>
                    <menu class="indentline">
                      {{- range . -}}
                        {{- if gt (len .RegularPages) 1 -}}
                          <li>
                            <details class="menu-fold">
                              <summary>{{- .Title -}}</summary>
                              <menu class="indentline">
                                {{- range .RegularPages -}}
                                  {{- if ne $page . -}}
                                    <li>
                                      <a
                                        class="sidelink"
                                        href="{{- .RelPermalink -}}"
                                        >{{- .LinkTitle -}}</a
                                      >
                                    </li>
                                  {{- end -}}
                                {{- end -}}
                              </menu>
                            </details>
                          </li>
                        {{- end -}}
                      {{- end -}}
                    </menu>
                  </details>
                </li>
              {{- end -}}
            {{- end -}}
          {{- end -}}
        </menu>
      </details>
    </div>
  {{- end -}}
{{- end -}}
