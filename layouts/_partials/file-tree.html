{{ $show := default true (default .Site.Params.showFileTree .Params.showFileTree) }}
{{ if $show }}
{{ $root := . }}

{{ with .Params.fileTreeRoot }}
  {{ $page := site.GetPage (printf "%s" .) }}
  {{ if $page }}
    {{ $root = $page }}
  {{ end }}
{{ end }}

{{- $displayroottitle := "" }}
{{ if $root.LinkTitle }}
  {{ $displayroottitle = $root.LinkTitle }}
{{ else if $root.Title }}
  {{ $displayroottitle = $root.Title }}
{{ else if and .IsSection .File }}
  {{ $displayroottitle = path.Base $root.File.Dir | humanize | title }}
{{ else if and .IsPage .File }}
  {{ $displayroottitle = $root.File.BaseFileName | humanize | title }}
{{ end }}

<section>
<details open class="filetree">
  <summary><b>{{print $displayroottitle}}</b></summary>
{{ partial "file-tree-list.html" (dict "context" $root "depth" 1) }}
</details>
</section>
{{ end }}

{{ define "file-tree-list.html"}}
{{ $context := .context }}
{{ $depth := .depth }}

<ul class="filetree">
  {{ range $context.Pages }}
    <li>
      {{- $displaytitle := "" }}
      {{ if .LinkTitle }}
        {{ $displaytitle = .LinkTitle }}
      {{ else if .Title }}
        {{ $displaytitle = .Title }}
      {{ else if and .IsSection .File }}
        {{ $displaytitle = path.Base .File.Dir | humanize | title }}
      {{ else if and .IsPage .File }}
        {{ $displaytitle = .File.BaseFileName | humanize | title }}
      {{ end }}

      {{ if .IsSection }}
        <details>
          <summary>
            <a href="{{ .RelPermalink }}">{{ $displaytitle }}</a>
          </summary>
          {{ partial "file-tree-list.html" (dict "context" . "depth" (add $depth 1)) }}
        </details>
      {{ else }}
        <a href="{{ .RelPermalink }}">{{ $displaytitle }}</a>
      {{ end }}
    </li>
  {{ end }}
</ul>
{{ end }}
